resource "aws_wafv2_ip_set" "nbe-ip-block" {
  ip_address_version = "IPV4"
  name               = "NBE-IP-Block"
  description        = "Ip sets which will be block to access NBE"
  scope              = "REGIONAL"
  addresses = [
    "168.151.211.2/32",
    "168.151.212.1/32",
    "168.151.233.1/32",
    "168.151.214.1/32",
    "185.240.128.1/32",
    "185.240.128.3/32",
    "185.240.130.1/32",
    "185.240.130.2/32",
    "185.240.128.2/32",
    "185.240.128.1/32",
    "185.209.4.109/32",
    "185.202.30.22/32",
    "45.139.233.24/32",
    "5.180.8.16/32",
    "185.209.4.121/32",
    "185.209.4.23/32",
    "185.209.5.154/32",
    "185.202.28.34/32",
    "185.209.7.111/32",
    "185.209.4.60/32",
    "176.118.189.1/32",
    "45.139.233.93/32",
    "185.209.5.10/32",
    "185.209.6.65/32",
    "185.202.30.12/32",
    "185.202.31.9/32",
    "185.202.29.25/32",
    "185.202.31.16/32",
    "185.209.5.60/32",
    "185.209.6.44/32",
    "185.209.7.13/32",
    "185.202.28.13/32",
    "185.202.29.41/32",
    "185.202.29.71/32",
    "185.202.28.12/32",
    "212.103.57.18/32",
    "46.149.160.19/32",
    "34.76.137.24/32",
    "34.78.16.93/32",
    "35.203.250.0/24",
    "35.203.251.0/24",
    "34.76.254.208/32",
    "34.78.48.205/32",
    "168.151.233.148/32",
    "168.151.212.147/32",
    "168.151.211.251/32",
    "185.240.128.242/32",
    "185.240.128.251/32",
    "168.151.214.128/32",
    "168.151.211.244/32",
    "185.240.128.33/32",
    "185.240.128.165/32",
    "185.240.128.154/32",
    "185.202.28.130/32",
    "185.202.29.253/32",
    "185.240.130.245/32",
    "185.202.31.165/32",
    "185.202.28.121/32",
    "185.202.30.121/32",
    "185.240.130.16/32",
    "185.202.30.228/32",
    "176.118.189.189/32",
    "185.240.128.246/32",
    "45.139.233.241/32",
    "185.202.29.41/32",
    "45.134.106.100/32",
    "45.134.107.251/32",
    "45.134.105.59/32",
    "45.134.105.196/32",
    "45.134.105.187/32",
    "45.134.107.186/32",
    "45.134.105.87/32",
    "45.134.106.132/32",
    "45.134.105.172/32",
    "45.134.104.209/32",
    "45.134.106.29/32",
    "45.134.105.116/32",
    "45.134.105.97/32",
    "45.134.105.153/32",
    "45.134.106.114/32",
    "45.134.105.218/32",
    "45.134.106.146/32",
    "45.134.107.235/32",
    "45.134.104.105/32",
    "45.134.104.243/32",
    "45.134.107.73/32",
    "45.134.104.175/32",
    "45.134.106.130/32",
    "45.134.107.54/32",
    "45.134.105.135/32",
    "45.134.104.165/32",
    "45.134.104.106/32",
    "45.134.105.37/32",
    "45.134.106.127/32",
    "45.134.105.220/32",
    "45.134.106.16/32",
    "45.134.105.16/32",
    "45.134.106.111/32",
    "45.134.106.160/32",
    "45.134.106.207/32",
    "45.134.106.12/32",
    "45.134.107.32/32",
    "45.134.107.153/32",
    "45.134.106.254/32",
    "45.134.106.11/32",
    "45.134.107.17/32",
    "45.134.107.27/32",
    "45.134.104.201/32",
    "45.134.104.246/32",
    "45.134.107.158/32",
    "45.134.105.104/32",
    "45.134.105.65/32",
    "45.134.106.156/32",
    "45.134.105.94/32",
    "45.134.105.189/32",
    "45.134.104.180/32",
    "45.134.107.183/32",
    "45.134.107.75/32",
    "45.134.106.243/32",
    "45.134.107.155/32",
    "45.134.106.23/32",
    "45.134.106.246/32",
    "45.134.105.58/32",
    "45.134.105.71/32",
    "45.134.106.124/32",
    "45.134.106.184/32",
    "45.134.105.43/32",
    "45.134.105.228/32",
    "45.134.106.142/32",
    "45.134.106.134/32",
    "45.134.105.233/32",
    "45.134.107.110/32",
    "45.134.105.139/32",
    "45.134.104.191/32",
    "45.134.104.114/32",
    "45.134.104.115/32",
    "45.134.105.204/32",
    "45.134.106.118/32",
    "45.134.105.224/32",
    "45.134.106.159/32",
    "45.134.105.178/32",
    "45.134.105.90/32",
    "45.134.106.248/32",
    "45.134.104.127/32",
    "45.134.106.219/32",
    "45.134.106.126/32",
    "45.134.105.33/32",
    "45.134.104.60/32",
    "45.134.107.42/32",
    "45.134.106.168/32",
    "45.134.106.42/32",
    "45.134.104.192/32",
    "45.134.105.51/32",
    "45.134.105.109/32",
    "45.134.106.166/32",
    "45.134.106.151/32",
    "45.134.105.248/32",
    "45.131.224.79/32"
  ]
}

resource "aws_wafv2_web_acl" "nbe" {
  name        = "NBE"
  description = "Web ACL to manage traffic on Booking engine UI and API"
  scope       = "REGIONAL"

  default_action {
    allow {}
  }

  rule {
    name     = "NBE-IP-Block"
    priority = 0

    action {
      block {}
    }

    statement {
      ip_set_reference_statement {
        arn = aws_wafv2_ip_set.nbe-ip-block.arn
      }
    }
    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "NBE-IP-Block"
      sampled_requests_enabled   = true
    }
  }


  rule {
    name     = "AWS-AWSManagedRulesAmazonIpReputationList"
    priority = 1
    override_action {
      none {}
    }
    statement {
      managed_rule_group_statement {
        name        = "AWSManagedRulesAmazonIpReputationList"
        vendor_name = "AWS"
      }
    }
    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWS-AWSManagedRulesAmazonIpReputationList"
      sampled_requests_enabled   = true
    }
  }

  rule {
    name     = "AWS-AWSManagedRulesAnonymousIpList"
    priority = 2
    override_action {
      none {}
    }
    statement {
      managed_rule_group_statement {
        name        = "AWSManagedRulesAnonymousIpList"
        vendor_name = "AWS"
      }
    }
    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWS-AWSManagedRulesAnonymousIpList"
      sampled_requests_enabled   = true
    }
  }


  rule {
    name     = "NBE-Rate-Limit"
    priority = 3

    action {
      block {}
    }

    statement {
      rate_based_statement {
        limit              = 300
        aggregate_key_type = "IP"
      }
    }
    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "NBE-Rate-Limit"
      sampled_requests_enabled   = true
    }
  }


  visibility_config {
    cloudwatch_metrics_enabled = true
    metric_name                = "NBE-WAF"
    sampled_requests_enabled   = true
  }
}